<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <record id="view_purchase_order_form_inherit" model="ir.ui.view">
            <field name="name">purchase.order.form.inherit.vendor_assignments</field>
            <field name="model">purchase.order</field>
            <field name="inherit_id" ref="purchase.purchase_order_form"/>
            <field name="arch" type="xml">

                <!-- Approval Buttons -->
                <xpath expr="//header" position="inside">
                    <button name="action_initiate_request"
                            string="Initiate Request"
                            type="object"
                            groups="purchase_extension.group_purchase_creator"/>

                    <button name="action_gm_approve"
                            string="GM Approve"
                            type="object"
                            class="oe_highlight"
                            groups="purchase_extension.group_general_manager">
                        <invisible eval="approval_state != 'to_approve'"/>
                    </button>

                    <button name="action_level1_approve"
                            string="Level 1 Approve"
                            type="object"
                            groups="purchase_extension.group_level1_approval"/>

                    <button name="action_level2_approve"
                            string="Confirm Order"
                            type="object"
                            groups="purchase_extension.group_level2_approval"/>
                </xpath>

                <!-- Restrict Vendor field to GM+Approvers -->
                <xpath expr="//field[@name='partner_id']" position="attributes">
                    <attribute name="groups">
                        purchase_extension.group_general_manager,
                        purchase_extension.group_level1_approval,
                        purchase_extension.group_level2_approval
                    </attribute>
                </xpath>

                <!-- Replace Order Lines with Vendor Assignment fields -->
                <xpath expr="//field[@name='order_line']" position="replace">
                    <field name="order_line" mode="list,form" editable="bottom">
                        <list>
                            <field name="product_id"/>
                            <field name="product_qty" string="Quantity"/>
                            <field name="product_uom"/>
                            <field name="price_unit"/>
                            <field name="gm_vendor_id" groups="purchase_extension.group_general_manager"/>
                            <field name="vendor_id_display" string="Vendor"/>
                        </list>
                        <form>
                            <sheet>
                                <group>
                                    <field name="product_id"/>
                                    <field name="product_qty"/>
                                    <field name="product_uom"/>
                                    <field name="price_unit"/>
                                    <field name="gm_vendor_id" groups="purchase_extension.group_general_manager"/>
                                    <field name="vendor_id_display" readonly="1"/>
                                </group>
                                <group>
                                    <field name="price_subtotal" readonly="1"/>
                                </group>
                            </sheet>
                        </form>
                    </field>
                </xpath>

                <!-- Add Vendor Assignments tab inside existing notebook -->
                <xpath expr="//sheet/notebook" position="inside">
                    <page string="Vendor Assignments" groups="purchase_extension.group_general_manager">
                        <field name="vendor_assigned_ids" mode="list,form">
                            <list editable="bottom">
                                <field name="product_id"/>
                                <field name="vendor_id"/>
                                <field name="quantity"/>
                                <field name="branch_id" readonly="1"/>
                            </list>
                            <form>
                                <group>
                                    <field name="product_id"/>
                                    <field name="vendor_id"/>
                                    <field name="quantity"/>
                                    <field name="branch_id" readonly="1"/>
                                </group>
                            </form>
                        </field>
                    </page>
                </xpath>

            </field>
        </record>
    </data>
</odoo>
